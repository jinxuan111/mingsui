<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„å­¦Â·å¸è¿å¤§å¸ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Rajdhani:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- å¼•å…¥html2canvasç”¨äºç”Ÿæˆå›¾ç‰‡ -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --bg-primary: #0f0c29;
            --bg-secondary: #302b63;
            --bg-tertiary: #24243e;
            --accent-neon: #00ff88;
            --accent-purple: #667eea;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0ff;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Rajdhani', sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 40px 20px;
            background-attachment: fixed;
        }

        .container {
            max-width: 1500px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 60px;
            animation: fadeInDown 1s ease;
        }

        h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 56px;
            font-weight: 900;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-neon));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.5);
        }

        .subtitle {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-secondary);
            margin-top: 10px;
            letter-spacing: 2px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.4fr;
            gap: 50px;
            align-items: start;
        }

        .panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.4);
            animation: slideInLeft 0.8s ease;
        }

        .form-group {
            margin-bottom: 28px;
        }

        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 16px;
            color: var(--accent-neon);
            letter-spacing: 1px;
        }

        input, select {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid var(--accent-purple);
            border-radius: 12px;
            font-size: 17px;
            color: white;
            transition: all 0.3s;
            appearance: none;
            -webkit-appearance: none;
        }

        /* è‡ªå®šä¹‰ä¸‹æ‹‰ç®­å¤´ */
        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='%2300ff88' viewBox='0 0 24 24'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 16px center;
            background-size: 12px;
        }

        /* å¼ºåˆ¶é€‰é¡¹æ–‡å­—å’ŒèƒŒæ™¯é¢œè‰² */
        select option {
            background-color: var(--bg-primary) !important;
            color: var(--accent-neon) !important;
            font-size: 17px !important;
        }

        /* é€‰ä¸­é«˜äº® */
        select option:checked {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-neon)) !important;
            color: white !important;
        }

        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-neon);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        button {
            width: 100%;
            padding: 18px;
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-neon));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 20px;
            font-weight: 700;
            letter-spacing: 2px;
            cursor: pointer;
            transition: all 0.4s;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        button:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 40px rgba(0, 255, 136, 0.6);
        }

        .share-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .share-btn {
            flex: 1;
            padding: 15px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        .share-btn.download {
            background: linear-gradient(90deg, #4ECDC4, #44A08D);
        }

        .share-btn.download:hover {
            box-shadow: 0 10px 25px rgba(78, 205, 196, 0.4);
        }

        .result-hidden {
            display: none;
        }

        .result-card {
            background: var(--glass);
            backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s;
        }

        .result-card:hover {
            transform: translateY(-8px);
        }

        .result-card h3 {
            font-family: 'Orbitron', sans-serif;
            font-size: 28px;
            color: var(--accent-neon);
            margin-bottom: 24px;
            text-align: center;
            letter-spacing: 1.5px;
        }

        /* å¸åœˆä¸“å±é¡¶çº§å¡ç‰‡ */
        #cryptoCard {
            background: linear-gradient(135deg, #1a0033 0%, #0f0c29 100%);
            border: 2px solid var(--accent-neon);
            box-shadow: 0 0 40px rgba(0, 255, 136, 0.5);
            padding: 40px;
            border-radius: 24px;
            text-align: center;
            position: relative;
        }

        #cryptoCard h3 {
            font-size: 36px;
            margin-bottom: 30px;
        }

        #cryptoAdvice {
            font-size: 20px;
            line-height: 2.2;
            text-align: left;
            white-space: pre-line;
            background: rgba(0, 0, 0, 0.3);
            padding: 25px;
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .bazi-display {
            font-size: 28px;
            font-weight: 600;
            line-height: 2;
            text-align: center;
            padding: 30px;
            background: var(--glass);
            border-radius: 16px;
            border: 1px solid var(--glass-border);
        }

        .wuxing-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
        }

        .wuxing-item {
            background: var(--glass);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            border: 1px solid var(--glass-border);
            transition: all 0.3s;
        }

        .wuxing-item:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 255, 136, 0.3);
        }

        .wuxing-count {
            font-size: 42px;
            font-weight: 700;
            margin-top: 10px;
            color: var(--accent-neon);
        }

        .fortune-bar-container {
            margin-bottom: 30px;
        }

        .fortune-bar-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 12px;
            font-weight: 600;
            font-size: 20px;
        }

        .fortune-bar {
            height: 20px;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 10px rgba(0,0,0,0.3);
        }

        .fortune-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #00ff88);
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.6);
            transition: width 1.5s ease;
        }

        .analysis-text {
            background: var(--glass);
            padding: 28px;
            border-radius: 16px;
            line-height: 2;
            font-size: 17px;
            border: 1px solid var(--glass-border);
        }

        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 30px;
            justify-content: center;
        }

        .tab-btn {
            padding: 14px 32px;
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            font-weight: 600;
            font-size: 17px;
            cursor: pointer;
            transition: all 0.4s;
        }

        .tab-btn.active {
            background: linear-gradient(90deg, var(--accent-purple), var(--accent-neon));
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.5);
        }

        .tab-btn:hover {
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† */
        #imagePreviewContainer {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        #imagePreview {
            max-width: 90%;
            max-height: 90%;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0, 255, 136, 0.5);
        }

        .preview-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .preview-btn {
            padding: 12px 24px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .preview-btn:hover {
            background: linear-gradient(90deg, #00ff88, #667eea);
        }

        /* åœŸç‹—è¿åŠ¿å›¾ç‰‡æ¨¡æ¿ */
        #tugouImageTemplate {
            position: absolute;
            left: -9999px;
            top: -9999px;
            width: 1200px;
            height: 630px;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
            color: white;
            padding: 40px;
            font-family: 'Rajdhani', sans-serif;
        }

        .tugou-header {
            text-align: center;
            margin-bottom: 30px;
        }

        .tugou-header h1 {
            font-family: 'Orbitron', sans-serif;
            font-size: 48px;
            background: linear-gradient(90deg, #667eea, #00ff88);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .tugou-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-bottom: 30px;
        }

        .tugou-wuxing {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .tugou-advice {
            background: rgba(255, 255, 255, 0.05);
            padding: 30px;
            border-radius: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            font-size: 18px;
            line-height: 1.8;
        }

        .tugou-footer {
            text-align: center;
            color: #a0a0ff;
            font-size: 16px;
            margin-top: 20px;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-40px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideInLeft {
            from { opacity: 0; transform: translateX(-60px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            h1 { font-size: 42px; }
            .share-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ç„å­¦Â·å¸è¿å¤§å¸ˆ</h1>
            <p class="subtitle">å…«å­—æ’ç›˜ Â· äº”è¡Œæ¨æ¼” Â· ä¸“å±åœŸç‹—è¿åŠ¿</p>
        </header>

        <div class="main-content">
            <!-- è¾“å…¥é¢æ¿ -->
            <div class="panel">
                <h2 style="text-align: center; font-family: 'Orbitron', sans-serif; font-size: 28px; margin-bottom: 40px; color: var(--accent-neon);">
                    è¾“å…¥å‡ºç”Ÿä¿¡æ¯
                </h2>

                <div class="form-group">
                    <label>å‡ºç”Ÿå¹´ä»½</label>
                    <input type="number" id="year" min="1900" max="2026" value="1995">
                </div>

                <div class="form-group">
                    <label>å‡ºç”Ÿæœˆä»½</label>
                    <select id="month">
                        <option value="1" selected>1æœˆ</option>
                        <option value="2">2æœˆ</option>
                        <option value="3">3æœˆ</option>
                        <option value="4">4æœˆ</option>
                        <option value="5">5æœˆ</option>
                        <option value="6">6æœˆ</option>
                        <option value="7">7æœˆ</option>
                        <option value="8">8æœˆ</option>
                        <option value="9">9æœˆ</option>
                        <option value="10">10æœˆ</option>
                        <option value="11">11æœˆ</option>
                        <option value="12">12æœˆ</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¥æœŸ</label>
                    <select id="day"></select>
                </div>

                <div class="form-group">
                    <label>å‡ºç”Ÿæ—¶è¾°ï¼ˆå¤§è‡´å³å¯ï¼‰</label>
                    <select id="hour">
                        <option value="0">å­æ—¶ 23-01</option>
                        <option value="1">ä¸‘æ—¶ 01-03</option>
                        <option value="3">å¯…æ—¶ 03-05</option>
                        <option value="5">å¯æ—¶ 05-07</option>
                        <option value="7">è¾°æ—¶ 07-09</option>
                        <option value="9">å·³æ—¶ 09-11</option>
                        <option value="11">åˆæ—¶ 11-13</option>
                        <option value="13">æœªæ—¶ 13-15</option>
                        <option value="15">ç”³æ—¶ 15-17</option>
                        <option value="17">é…‰æ—¶ 17-19</option>
                        <option value="19">æˆŒæ—¶ 19-21</option>
                        <option value="21">äº¥æ—¶ 21-23</option>
                        <option value="12" selected>æœªçŸ¥ï¼ˆå–ä¸­åˆï¼‰</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>æ€§åˆ«</label>
                    <select id="gender">
                        <option value="male">ç”·</option>
                        <option value="female">å¥³</option>
                    </select>
                </div>

                <button onclick="calculateFortune()">å¼€å§‹æ¨æ¼”</button>
            </div>

            <!-- ç»“æœé¢æ¿ -->
            <div id="resultContainer" class="result-panel result-hidden">
                <div class="tabs">
                    <button class="tab-btn active" onclick="switchTab(event, 'tab-crypto')">å¸åœˆÂ·åœŸç‹—è¿åŠ¿</button>
                    <button class="tab-btn" onclick="switchTab(event, 'tab-basic')">åŸºç¡€ä¿¡æ¯</button>
                    <button class="tab-btn" onclick="switchTab(event, 'tab-fortune')">è¿åŠ¿æŒ‡æ•°</button>
                    <button class="tab-btn" onclick="switchTab(event, 'tab-detail')">è¯¦ç»†æŠ¥å‘Š</button>
                </div>

                <!-- å¸åœˆÂ·åœŸç‹—è¿åŠ¿ -->
                <div id="tab-crypto" class="tab-content active">
                    <div id="cryptoCard">
                        <h3>å¸åœˆÂ·åœŸç‹—è¿åŠ¿ï¼ˆä»Šå¤©é€‚åˆæ‰“ç‹—å—ï¼Ÿï¼‰</h3>
                        <div id="cryptoAdvice"></div>
                        <!-- åˆ†äº«å’Œå›¾ç‰‡ç”ŸæˆæŒ‰é’® -->
                        <div class="share-buttons">
                            <button class="share-btn" onclick="shareToWechat()">
                                <span>ğŸ“±</span>åˆ†äº«ç»™å¥½å‹
                            </button>
                            <button class="share-btn download" onclick="generateTugouImage()">
                                <span>ğŸ“·</span>ç”Ÿæˆè¿åŠ¿å›¾ç‰‡
                            </button>
                        </div>
                    </div>
                </div>

                <!-- åŸºç¡€ä¿¡æ¯ -->
                <div id="tab-basic" class="tab-content">
                    <div class="result-card">
                        <h3>å…«å­—æ’ç›˜</h3>
                        <div id="baziDisplay" class="bazi-display"></div>
                    </div>

                    <div class="result-card">
                        <h3>äº”è¡Œåˆ†å¸ƒ</h3>
                        <div id="wuxingGrid" class="wuxing-grid"></div>
                    </div>
                </div>

                <!-- è¿åŠ¿æŒ‡æ•° -->
                <div id="tab-fortune" class="tab-content">
                    <div class="result-card">
                        <h3>ç»¼åˆè¿åŠ¿æŒ‡æ•°</h3>
                        <div class="fortune-bar-container">
                            <div class="fortune-bar-label"><span>ç»¼åˆè¿åŠ¿</span><span id="overallValue">0%</span></div>
                            <div class="fortune-bar"><div id="overallBar" class="fortune-bar-fill" style="width:0%"></div></div>
                        </div>
                        <div class="fortune-bar-container">
                            <div class="fortune-bar-label"><span>è´¢è¿</span><span id="wealthValue">0%</span></div>
                            <div class="fortune-bar"><div id="wealthBar" class="fortune-bar-fill" style="width:0%"></div></div>
                        </div>
                        <div class="fortune-bar-container">
                            <div class="fortune-bar-label"><span>äº‹ä¸šè¿</span><span id="careerValue">0%</span></div>
                            <div class="fortune-bar"><div id="careerBar" class="fortune-bar-fill" style="width:0%"></div></div>
                        </div>
                        <div class="fortune-bar-container">
                            <div class="fortune-bar-label"><span>æ„Ÿæƒ…è¿</span><span id="loveValue">0%</span></div>
                            <div class="fortune-bar"><div id="loveBar" class="fortune-bar-fill" style="width:0%"></div></div>
                        </div>
                        <div class="fortune-bar-container">
                            <div class="fortune-bar-label"><span>å¥åº·è¿</span><span id="healthValue">0%</span></div>
                            <div class="fortune-bar"><div id="healthBar" class="fortune-bar-fill" style="width:0%"></div></div>
                        </div>
                    </div>
                </div>

                <!-- è¯¦ç»†æŠ¥å‘Š -->
                <div id="tab-detail" class="tab-content">
                    <div class="result-card"><h3>åŸºç¡€ä¿¡æ¯</h3><div id="basicInfo" class="analysis-text"></div></div>
                    <div class="result-card"><h3>å…«å­—åˆ†æ</h3><div id="baziAnalysis" class="analysis-text"></div></div>
                    <div class="result-card"><h3>äº”è¡Œåˆ†æ</h3><div id="wuxingAnalysis" class="analysis-text"></div></div>
                    <div class="result-card"><h3>ç»¼åˆè¿åŠ¿</h3><div id="fortuneAnalysis" class="analysis-text"></div></div>
                    <div class="result-card"><h3>è´¢è¿åˆ†æ</h3><div id="wealthAnalysis" class="analysis-text"></div></div>
                    <div class="result-card"><h3>äº‹ä¸šåˆ†æ</h3><div id="careerAnalysis" class="analysis-text"></div></div>
                    <div class="result-card"><h3>æ„Ÿæƒ…åˆ†æ</h3><div id="loveAnalysis" class="analysis-text"></div></div>
                    <div class="result-card"><h3>å¥åº·å»ºè®®</h3><div id="healthAdvice" class="analysis-text"></div></div>
                    <div class="result-card"><h3>é€æœˆè¿åŠ¿</h3><div id="monthlyFortune" class="analysis-text"></div></div>
                    <div class="result-card"><h3>æ”¹è¿å»ºè®®</h3><div id="improveAdvice" class="analysis-text"></div></div>
                </div>
            </div>
        </div>
    </div>

    <!-- å›¾ç‰‡é¢„è§ˆæ¨¡æ€æ¡† -->
    <div id="imagePreviewContainer">
        <div class="preview-controls">
            <button class="preview-btn" onclick="downloadImage()">ä¸‹è½½å›¾ç‰‡</button>
            <button class="preview-btn" onclick="closePreview()">å…³é—­</button>
        </div>
        <img id="imagePreview" alt="è¿åŠ¿å›¾ç‰‡é¢„è§ˆ">
    </div>

    <!-- éšè—çš„å›¾ç‰‡ç”Ÿæˆæ¨¡æ¿ -->
    <div id="tugouImageTemplate">
        <div class="tugou-header">
            <h1>ç„å­¦Â·å¸è¿å¤§å¸ˆ</h1>
            <p style="color: #a0a0ff; font-size: 24px; margin-bottom: 10px;">ä¸“å±åœŸç‹—è¿åŠ¿åˆ†æ</p>
            <p style="color: #00ff88; font-size: 20px;">ç”Ÿæˆæ—¶é—´ï¼š<span id="templateDate"></span></p>
        </div>
        
        <div class="tugou-content">
            <div class="tugou-wuxing">
                <h3 style="color: #00ff88; font-size: 28px; margin-bottom: 20px;">âœ¨ äº”è¡Œåˆ†æ</h3>
                <div id="templateWuxing" style="font-size: 20px; line-height: 2;">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
            
            <div class="tugou-advice">
                <h3 style="color: #00ff88; font-size: 28px; margin-bottom: 20px;">ğŸ”¥ ä»Šæ—¥åœŸç‹—å»ºè®®</h3>
                <div id="templateAdvice" style="font-size: 18px; line-height: 1.8;">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </div>
        </div>
        
        <div class="tugou-footer">
            <p>ç„å­¦Â·å¸è¿å¤§å¸ˆ - ä»…ä¾›å¨±ä¹å‚è€ƒï¼ŒæŠ•èµ„æœ‰é£é™©</p>
            <p style="font-size: 14px; margin-top: 10px;">æ‰«æäºŒç»´ç è·å–ä½ çš„ä¸“å±è¿åŠ¿</p>
        </div>
    </div>

    <script>
        class FortuneEngine {
            constructor() {
                this.heavenStems = ['ç”²', 'ä¹™', 'ä¸™', 'ä¸', 'æˆŠ', 'å·±', 'åºš', 'è¾›', 'å£¬', 'ç™¸'];
                this.earthBranches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
                this.stemWuXing = { 'ç”²': 'æœ¨', 'ä¹™': 'æœ¨', 'ä¸™': 'ç«', 'ä¸': 'ç«', 'æˆŠ': 'åœŸ', 'å·±': 'åœŸ', 'åºš': 'é‡‘', 'è¾›': 'é‡‘', 'å£¬': 'æ°´', 'ç™¸': 'æ°´' };
                this.branchWuXing = { 'å­': 'æ°´', 'ä¸‘': 'åœŸ', 'å¯…': 'æœ¨', 'å¯': 'æœ¨', 'è¾°': 'åœŸ', 'å·³': 'ç«', 'åˆ': 'ç«', 'æœª': 'åœŸ', 'ç”³': 'é‡‘', 'é…‰': 'é‡‘', 'æˆŒ': 'åœŸ', 'äº¥': 'æ°´' };
            }

            yearToGanZhi(year) {
                const stemIndex = (year - 4) % 10;
                const branchIndex = (year - 4) % 12;
                return this.heavenStems[stemIndex] + this.earthBranches[branchIndex];
            }

            monthToGanZhi(year, month) {
                const yearGanZhi = this.yearToGanZhi(year);
                const yearStemIndex = this.heavenStems.indexOf(yearGanZhi[0]);
                const monthStemIndex = (yearStemIndex * 2 + month + 1) % 10;
                const monthBranchIndex = month - 1;
                return this.heavenStems[monthStemIndex] + this.earthBranches[monthBranchIndex];
            }

            dayToGanZhi(year, month, day) {
                const base = new Date(1900, 0, 31);
                const current = new Date(year, month - 1, day);
                const days = Math.floor((current - base) / 86400000);
                const stemIndex = (days + 60) % 10;
                const branchIndex = (days + 60) % 12;
                return this.heavenStems[stemIndex] + this.earthBranches[branchIndex];
            }

            hourToGanZhi(dayGanZhi, hour) {
                const dayStemIndex = this.heavenStems.indexOf(dayGanZhi[0]);
                const hourBranchMap = [0,1,2,3,4,5,6,7,8,9,10,11];
                let hourBranchIndex = hourBranchMap[Math.floor(hour / 2)];
                if (hour === 23 || hour === 0) hourBranchIndex = 0;
                const hourStemIndex = (dayStemIndex * 2 + hourBranchIndex) % 10;
                return this.heavenStems[hourStemIndex] + this.earthBranches[hourBranchIndex];
            }

            getBaZi(year, month, day, hour) {
                const y = this.yearToGanZhi(year);
                const m = this.monthToGanZhi(year, month);
                const d = this.dayToGanZhi(year, month, day);
                const h = this.hourToGanZhi(d, hour);
                return { year: y, month: m, day: d, hour: h, full: `${y} ${m} ${d} ${h}` };
            }

            getWuXingCount(baZi) {
                const chars = (baZi.year + baZi.month + baZi.day + baZi.hour);
                const count = { 'æœ¨': 0, 'ç«': 0, 'åœŸ': 0, 'é‡‘': 0, 'æ°´': 0 };
                for (let c of chars) {
                    if (this.stemWuXing[c]) count[this.stemWuXing[c]]++;
                    if (this.branchWuXing[c]) count[this.branchWuXing[c]]++;
                }
                return count;
            }

            calculateDayMasterStrength(baZi) {
                const dm = baZi.day[0];
                const wx = this.stemWuXing[dm];
                let strength = 50;
                ['year','month','day','hour'].forEach(p => {
                    if (this.stemWuXing[baZi[p][0]] === wx) strength += (p === 'day' ? 30 : p === 'month' ? 20 : 15);
                    if (this.branchWuXing[baZi[p][1]] === wx) strength += (p === 'day' ? 20 : p === 'month' ? 15 : 10);
                });
                return Math.min(Math.round(strength), 100);
            }

            generateFortune(year, month, day, hour, gender) {
                const baZi = this.getBaZi(year, month, day, hour);
                const wuXingCount = this.getWuXingCount(baZi);
                const dayMasterStrength = this.calculateDayMasterStrength(baZi);
                const dayMasterWuXing = this.stemWuXing[baZi.day[0]];
                const today = new Date();
                let age = today.getFullYear() - year;
                if (today.getMonth() + 1 < month || (today.getMonth() + 1 === month && today.getDate() < day)) age--;

                const max = Math.max(...Object.values(wuXingCount));
                const min = Math.min(...Object.values(wuXingCount));
                const balance = max === 0 ? 50 : Math.round(100 - (max - min) * 12.5);

                const indices = {
                    overall: Math.round((dayMasterStrength + balance) / 2),
                    wealth: Math.min(Math.round((wuXingCount['æœ¨'] + wuXingCount['ç«']) * 12), 100),
                    career: Math.round(balance * 0.9),
                    love: Math.round(balance * 0.85),
                    health: dayMasterStrength,
                    balance: balance
                };

                return { baZi, wuXingCount, dayMasterStrength, dayMasterWuXing, age, gender, fortuneIndices: indices };
            }
        }

        class DetailedAnalysisGenerator {
            constructor() {
                this.wuXingDescriptions = {
                    'æœ¨': { åç§°: 'æœ¨', é¢œè‰²: 'ç»¿è‰²', æ–¹å‘: 'ä¸œæ–¹', å­£èŠ‚: 'æ˜¥å­£', å™¨å®˜: 'è‚èƒ†', æƒ…ç»ª: 'æ€’', å‘³é“: 'é…¸' },
                    'ç«': { åç§°: 'ç«', é¢œè‰²: 'çº¢è‰²', æ–¹å‘: 'å—æ–¹', å­£èŠ‚: 'å¤å­£', å™¨å®˜: 'å¿ƒè„‘', æƒ…ç»ª: 'å–œ', å‘³é“: 'è‹¦' },
                    'åœŸ': { åç§°: 'åœŸ', é¢œè‰²: 'é»„è‰²', æ–¹å‘: 'ä¸­å¤®', å­£èŠ‚: 'å››å­£æœ«', å™¨å®˜: 'è„¾èƒƒ', æƒ…ç»ª: 'æ€', å‘³é“: 'ç”˜' },
                    'é‡‘': { åç§°: 'é‡‘', é¢œè‰²: 'ç™½è‰²', æ–¹å‘: 'è¥¿æ–¹', å­£èŠ‚: 'ç§‹å­£', å™¨å®˜: 'è‚ºè‚ ', æƒ…ç»ª: 'æ‚²', å‘³é“: 'è¾›' },
                    'æ°´': { åç§°: 'æ°´', é¢œè‰²: 'é»‘è‰²', æ–¹å‘: 'åŒ—æ–¹', å­£èŠ‚: 'å†¬å­£', å™¨å®˜: 'è‚¾è†€èƒ±', æƒ…ç»ª: 'æ', å‘³é“: 'å’¸' }
                };
            }

            generateFullReport(fortune) {
                return {
                    åŸºç¡€ä¿¡æ¯: this.generateBasicInfo(fortune),
                    å…«å­—åˆ†æ: this.generateBaZiAnalysis(fortune),
                    äº”è¡Œåˆ†æ: this.generateWuXingAnalysis(fortune),
                    è¿åŠ¿åˆ†æ: this.generateFortuneAnalysis(fortune),
                    è´¢è¿åˆ†æ: this.generateWealthAnalysis(fortune),
                    äº‹ä¸šåˆ†æ: this.generateCareerAnalysis(fortune),
                    æ„Ÿæƒ…åˆ†æ: this.generateLoveAnalysis(fortune),
                    å¥åº·å»ºè®®: this.generateHealthAdvice(fortune),
                    å¸åœˆåœŸç‹—è¿åŠ¿: this.generateCryptoAdvice(fortune),
                    é€æœˆè¿åŠ¿: this.generateMonthlyFortune(fortune),
                    æ”¹è¿å»ºè®®: this.generateImproveAdvice(fortune)
                };
            }

            generateBasicInfo(fortune) {
                return `å¹´é¾„ï¼š${fortune.age}å²\næ€§åˆ«ï¼š${fortune.gender === 'male' ? 'ç”·' : 'å¥³'}\nå…«å­—ï¼š${fortune.baZi.full}\næ—¥ä¸»ï¼š${fortune.baZi.day}\næ—¥ä¸»äº”è¡Œï¼š${fortune.dayMasterWuXing}\næ—¥ä¸»å¼ºå¼±ï¼š${fortune.dayMasterStrength}åˆ†`;
            }

            generateBaZiAnalysis(fortune) {
                const { baZi, dayMasterStrength, dayMasterWuXing } = fortune;
                let text = `ä½ çš„å…«å­—ä¸ºï¼š${baZi.full}\n\næ—¥ä¸»ï¼ˆæ—¥å¹²ï¼‰ä¸º${baZi.day[0]}ï¼Œå±${dayMasterWuXing}æ€§ã€‚\n\n`;
                if (dayMasterStrength > 70) text += `æ—¥ä¸»éå¸¸æ—ºç››ï¼ˆ${dayMasterStrength}åˆ†ï¼‰ï¼Œå¤©ç”Ÿè‡ªä¿¡ã€è¡ŒåŠ¨åŠ›å¼ºã€é¢†å¯¼åŠ›çªå‡ºã€‚ä½ æ˜¯å¤©ç”Ÿçš„é¢†å¯¼è€…ï¼Œå…·æœ‰æå¼ºçš„æ‰§è¡ŒåŠ›ã€‚`;
                else if (dayMasterStrength > 55) text += `æ—¥ä¸»è¾ƒæ—ºï¼ˆ${dayMasterStrength}åˆ†ï¼‰ï¼Œå…·å¤‡è‰¯å¥½è‡ªæˆ‘ç®¡ç†èƒ½åŠ›ï¼Œæ€§æ ¼ç¨³å¥ï¼Œäººæ ¼å¥å…¨ã€‚`;
                else if (dayMasterStrength > 40) text += `æ—¥ä¸»ä¸­ç­‰ï¼ˆ${dayMasterStrength}åˆ†ï¼‰ï¼Œæ€§æ ¼æ¸©å’Œï¼Œé€‚åº”åŠ›å¼ºï¼Œå–„äºåˆä½œã€‚`;
                else text += `æ—¥ä¸»åå¼±ï¼ˆ${dayMasterStrength}åˆ†ï¼‰ï¼Œéœ€å€ŸåŠ©å¤–åŠ›ä¸è´µäººï¼Œå®œå¤šå»ºç«‹äººè„‰ã€‚`;
                return text;
            }

            generateWuXingAnalysis(fortune) {
                const { wuXingCount } = fortune;
                const total = Object.values(wuXingCount).reduce((a,b)=>a+b,0);
                let text = 'äº”è¡Œåˆ†å¸ƒï¼š\n\n';
                for (let [wx, cnt] of Object.entries(wuXingCount)) {
                    const pct = Math.round(cnt/total*100);
                    const d = this.wuXingDescriptions[wx];
                    text += `${d.åç§°}ï¼š${cnt}ä¸ªï¼ˆ${pct}%ï¼‰ â†’ ${d.æ–¹å‘}ã€${d.å­£èŠ‚}ã€${d.å™¨å®˜}\n`;
                }
                const diff = Math.max(...Object.values(wuXingCount)) - Math.min(...Object.values(wuXingCount));
                text += '\näº”è¡Œå¹³è¡¡åº¦ï¼š\n';
                if (diff <= 2) text += 'éå¸¸å‡è¡¡ï¼Œå…ˆå¤©æ¡ä»¶æä½³ï¼Œæ€§æ ¼å¹³å’Œï¼Œå‘å±•å…¨é¢ã€‚';
                else if (diff <= 4) text += 'åŸºæœ¬å‡è¡¡ï¼Œç¨ä½œè°ƒç†å³å¯å…¨é¢å‘å±•ã€‚';
                else text += 'æœ‰æ‰€å¤±è¡¡ï¼Œéœ€é’ˆå¯¹æ€§è¡¥æ•‘çŸ­æ¿ã€‚';
                return text;
            }

            generateFortuneAnalysis(fortune) {
                const overall = fortune.fortuneIndices.overall;
                let text = `ç»¼åˆè¿åŠ¿æŒ‡æ•°ï¼š${overall}/100\n\nè¯¦ç»†æŒ‡æ•°ï¼š\nè´¢è¿ï¼š${fortune.fortuneIndices.wealth}/100\näº‹ä¸šï¼š${fortune.fortuneIndices.career}/100\næ„Ÿæƒ…ï¼š${fortune.fortuneIndices.love}/100\nå¥åº·ï¼š${fortune.fortuneIndices.health}/100`;
                return text;
            }

            generateWealthAnalysis(fortune) {
                const strength = fortune.dayMasterStrength;
                let text = 'è´¢è¿åˆ†æï¼š\n\n';
                if (strength > 70) text += 'æ—¥ä¸»å¼ºåŠ¿ï¼Œèšè´¢èƒ½åŠ›å¼ºï¼Œé€‚åˆåˆ›ä¸šæŠ•èµ„ï¼ŒæŠŠæ¡å•†æœºå¯å¤§å¯Œã€‚';
                else if (strength < 40) text += 'æ—¥ä¸»åå¼±ï¼Œå®œå®ˆæ­£è´¢ï¼Œç¨³å®šæ”¶å…¥ä¸ºä¸»ï¼Œé¿å…æŠ•æœºã€‚';
                else text += 'è´¢è¿ä¸­ç­‰ï¼Œå¯ç¨³ä¸­æ±‚è¿›ï¼Œé€‚åº¦ç†è´¢ã€‚';
                text += `\nä»Šå¹´è´¢è¿æŒ‡æ•°ï¼š${fortune.fortuneIndices.wealth}/100`;
                return text;
            }

            generateCareerAnalysis(fortune) {
                const wx = fortune.dayMasterWuXing;
                const paths = {
                    'æœ¨': ['æ•™è‚²ã€åŒ»ç–—ã€æ—ä¸šã€è®¾è®¡ã€ç®¡ç†'],
                    'ç«': ['èƒ½æºã€ç§‘æŠ€ã€ä¼ åª’ã€è¥é”€ã€æ³•å¾‹'],
                    'åœŸ': ['åœ°äº§ã€å»ºç­‘ã€å†œä¸šã€å…¬åŠ¡å‘˜'],
                    'é‡‘': ['é‡‘èã€æœºæ¢°ã€å†›è­¦ã€ç å®'],
                    'æ°´': ['è´¸æ˜“ã€æ—…æ¸¸ã€ç‰©æµã€ITã€è‰ºæœ¯']
                };
                let text = `é€‚åˆè¡Œä¸šï¼ˆä¾æ®${wx}å±æ€§ï¼‰ï¼š\n` + (paths[wx] || ['å¤šå…ƒè¡Œä¸š']).map((p,i)=>`${i+1}. ${p}`).join('\n') + '\n\n';
                if (fortune.dayMasterStrength > 70) text += 'å®œåˆ›ä¸šæˆ–é«˜å±‚ç®¡ç†ï¼Œé¢†å¯¼åŠ›å¼ºã€‚';
                else if (fortune.dayMasterStrength < 40) text += 'å®œç¨³å®šå¤§å¹³å°ï¼Œå€Ÿè´µäººä¹‹åŠ›ã€‚';
                else text += 'å¯åˆ›ä¸šä¹Ÿå¯æ·±è€•ä¸“ä¸šé¢†åŸŸã€‚';
                return text;
            }

            generateLoveAnalysis(fortune) {
                const traits = {
                    'æœ¨': 'çƒ­æƒ…ç›´ç‡ï¼Œä½†æ˜“å›ºæ‰§ã€‚éœ€å¤šå€¾å¬ä¸åŒ…å®¹ã€‚',
                    'ç«': 'æµªæ¼«æ¿€æƒ…ï¼Œä½†æƒ…ç»ªåŒ–ã€‚éœ€å¢åŠ è€å¿ƒã€‚',
                    'åœŸ': 'å¿ è¯šå¯é ï¼Œä½†å°‘æµªæ¼«ã€‚éœ€å¤šè¡¨è¾¾æƒ…æ„Ÿã€‚',
                    'é‡‘': 'ç†æ€§ä¸“ä¸€ï¼Œä½†æ˜¾å†·æ·¡ã€‚éœ€ä¸»åŠ¨ç¤ºæš–ã€‚',
                    'æ°´': 'æ¸©æŸ”ä½“è´´ï¼Œä½†å¤šæ•æ„Ÿã€‚éœ€å¢å¼ºè‡ªä¿¡ã€‚'
                };
                let text = `æ„Ÿæƒ…ç‰¹è´¨ï¼š${traits[fortune.dayMasterWuXing] || 'éœ€ç”¨å¿ƒç»è¥'}\n\nä»Šå¹´æ„Ÿæƒ…è¿ï¼š${fortune.fortuneIndices.love > 70 ? 'æä½³ï¼Œæ˜“é‡æ­£ç¼˜æˆ–å©šå§»ç¾æ»¡' : fortune.fortuneIndices.love > 50 ? 'å¹³ç¨³ï¼Œå¯é‡è‰¯ç¼˜' : 'éœ€ä¸»åŠ¨ï¼Œå¤šæ²Ÿé€š'}`;
                return text;
            }

            generateHealthAdvice(fortune) {
                const tips = {
                    'æœ¨': {å™¨å®˜:'è‚èƒ†', æ³¨æ„:'é˜²æ€’ä¼¤è‚ã€è¿‡åº¦åŠ³ç´¯', è°ƒç†:'æ˜¥å­£è¿åŠ¨ã€å¤šç»¿æ¤'},
                    'ç«': {å™¨å®˜:'å¿ƒè¡€ç®¡', æ³¨æ„:'é˜²å¿ƒç«ã€ä¸Šç«', è°ƒç†:'å¤å­£æ¸…çƒ­ã€é™å¿ƒ'},
                    'åœŸ': {å™¨å®˜:'è„¾èƒƒ', æ³¨æ„:'é¥®é£Ÿè§„å¾‹ã€é˜²æ¹¿é‡', è°ƒç†:'å¥è„¾ç¥›æ¹¿'},
                    'é‡‘': {å™¨å®˜:'è‚ºå‘¼å¸', æ³¨æ„:'é˜²ç§‹ç‡¥ã€æ‚²ä¼¤', è°ƒç†:'æ¶¦è‚ºå…»é˜´'},
                    'æ°´': {å™¨å®˜:'è‚¾æ³Œå°¿', æ³¨æ„:'é˜²å¯’ã€è‚¾è™š', è°ƒç†:'å†¬å­£è¡¥è‚¾ã€ä¿æš–'}
                };
                const t = tips[fortune.dayMasterWuXing];
                return `é‡ç‚¹å…³æ³¨ï¼š${t.å™¨å®˜}\næ³¨æ„äº‹é¡¹ï¼š${t.æ³¨æ„}\nè°ƒç†å»ºè®®ï¼š${t.è°ƒç†}\nä»Šå¹´å¥åº·æŒ‡æ•°ï¼š${fortune.fortuneIndices.health}/100`;
            }

            generateCryptoAdvice(fortune) {
                const wealth = fortune.fortuneIndices.wealth;
                const overall = fortune.fortuneIndices.overall;
                const wx = fortune.dayMasterWuXing;
                const strength = fortune.dayMasterStrength;
                const balance = fortune.fortuneIndices.balance;

                let advice = 'ğŸ”¥ å¸åœˆÂ·åœŸç‹—è¿åŠ¿æ·±åº¦åˆ†æï¼ˆçº¯å¨±ä¹ï¼ŒæŠ•èµ„æœ‰é£é™©ï¼‰ ğŸ”¥\n\n';

                const wxDetail = {
                    'æœ¨': { style: 'æˆé•¿å™äº‹å‹', recommend: 'Layer2ã€AIã€RWAã€æ¸¸æˆé“¾', color: 'ç»¿è‰²', number: '3ã€8' },
                    'ç«': { style: 'çƒ­ç‚¹çˆ†ç‚’å‹', recommend: 'Memeã€çƒ­æœæ¦‚å¿µã€ç¤¾äº¤Fi', color: 'çº¢è‰²', number: '2ã€7' },
                    'åœŸ': { style: 'ç¨³å¥è“ç­¹å‹', recommend: 'BTCã€ETHã€å¹³å°å¸ã€çŸ¿å¸', color: 'é»„è‰²', number: '5ã€10' },
                    'é‡‘': { style: 'é«˜é£é™©å®çŸ³å‹', recommend: 'æ½œåŠ›100xã€æ–°å…¬é“¾ã€DeFiåŸå§‹è‚¡', color: 'ç™½è‰²', number: '4ã€9' },
                    'æ°´': { style: 'å¿«è¿›å¿«å‡ºå‹', recommend: 'DEXã€è¡ç”Ÿå“ã€æµåŠ¨æ€§æŒ–çŸ¿', color: 'é»‘è‰²', number: '1ã€6' }
                };
                const detail = wxDetail[wx] || { style: 'å¹³è¡¡çµæ´»å‹', recommend: 'å¤šé“¾å¸ƒå±€', color: 'å¤šå½©', number: 'ä»»æ„' };

                advice += `ä½ çš„æ—¥ä¸»äº”è¡Œã€${wx}ã€‘\n`;
                advice += `ä¸“å±é£æ ¼ï¼š${detail.style}\n`;
                advice += `ä»Šæ—¥æ¨èæ¿å—ï¼š${detail.recommend}\n`;
                advice += `å¹¸è¿é¢œè‰²ï¼š${detail.color} | å¹¸è¿æ•°å­—ï¼š${detail.number}\n\n`;

                let level, risk, position;
                if (wealth >= 90) {
                    level = 'æä½³ï¼ˆå¤©èµè‰¯æœºï¼‰';
                    risk = 'ä½é£é™©é«˜å›æŠ¥';
                    position = 'å¯é‡ä»“ï¼ˆ50-80%ï¼‰';
                } else if (wealth >= 80) {
                    level = 'æ—ºç››ï¼ˆè´¢æ˜Ÿé«˜ç…§ï¼‰';
                    risk = 'ä½é£é™©';
                    position = 'å¯ä¸­é‡ä»“ï¼ˆ30-60%ï¼‰';
                } else if (wealth >= 70) {
                    level = 'è‰¯å¥½ï¼ˆè´µäººåŠ©åŠ›ï¼‰';
                    risk = 'ä¸­ä½é£é™©';
                    position = 'ä¸­ä»“ä½ï¼ˆ20-40%ï¼‰';
                } else if (wealth >= 60) {
                    level = 'ä¸­ç­‰åä¸Šï¼ˆå°æœ‰æœºä¼šï¼‰';
                    risk = 'ä¸­ç­‰é£é™©';
                    position = 'è½»ä»“è¯•æ°´ï¼ˆ10-25%ï¼‰';
                } else if (wealth >= 45) {
                    level = 'ä¸­ç­‰ï¼ˆéœ‡è¡å¸‚ï¼‰';
                    risk = 'ä¸­ç­‰åé«˜';
                    position = 'å°ä»“æ€¡æƒ…ï¼ˆâ‰¤10%ï¼‰';
                } else if (wealth >= 30) {
                    level = 'åå¼±ï¼ˆæ˜“è¢«å‰²ï¼‰';
                    risk = 'é«˜é£é™©';
                    position = 'ä¸å»ºè®®é‡ä»“ï¼Œè§‚æœ›ä¸ºä¸»';
                } else {
                    level = 'å¾ˆå·®ï¼ˆå‡¶æ˜Ÿå¹²æ‰°ï¼‰';
                    risk = 'æé«˜é£é™©';
                    position = 'å¼ºçƒˆä¸å»ºè®®æ“ä½œ';
                }

                advice += `ä»Šæ—¥åœŸç‹—è¿åŠ¿ç­‰çº§ï¼š${level}\n`;
                advice += `é£é™©ç­‰çº§ï¼š${risk}\n`;
                advice += `å»ºè®®ä»“ä½ï¼š${position}\n\n`;

                advice += `è¯¦ç»†è§£æï¼š\n`;
                if (wealth >= 80) {
                    advice += 'è´¢è¿çˆ†æ£šï¼Œå®¹æ˜“åƒå¤§è‚‰ï¼ä»Šå¤©ä¸Šæ–°ã€çƒ­memeã€KOLå¸¦é£é¡¹ç›®ä¸ä½ é«˜åº¦å…±æŒ¯ã€‚\nå»ºè®®å¤§èƒ†å‡ºå‡»ï¼Œä½†è§å¥½å°±æ”¶ï¼Œè½è¢‹ä¸ºå®‰æ˜¯ç‹é“ï¼';
                } else if (wealth >= 70) {
                    advice += 'åœŸç‹—è¿ä¸é”™ï¼Œæœ‰æƒŠå–œæœºä¼šï¼è½»ä¸­ä»“ä½è·Ÿçƒ­ç‚¹ï¼Œå®¹æ˜“å°èµšä¸€æ³¢ã€‚\nå…³æ³¨ç¤¾åŒºæƒ…ç»ªé«˜ã€äº¤æ˜“é‡çˆ†å‘çš„æ–°é¡¹ç›®ã€‚';
                } else if (wealth >= 60) {
                    advice += 'è¿åŠ¿å¹³ç¨³ï¼Œå¯å°ç©æ€¡æƒ…ã€‚ä¼˜å…ˆè€é¡¹ç›®æˆ–æœ‰åŸºæœ¬é¢æ”¯æ’‘çš„åœŸç‹—ï¼Œé¿å…ç›²ç›®FOMOã€‚';
                } else if (wealth >= 45) {
                    advice += 'å¸‚åœºéœ‡è¡ï¼ŒåœŸç‹—å®¹æ˜“å‡çªç ´ã€‚å»ºè®®è§‚æœ›ä¸ºä¸»ï¼Œåªç”¨å¨±ä¹èµ„é‡‘å°è¯•ï¼Œé¿å…è¿½é«˜ã€‚';
                } else if (wealth >= 30) {
                    advice += 'è¿åŠ¿åå¼±ï¼Œå®¹æ˜“ç«™å²—ã€‚ä»Šæ—¥ä¸å®œé‡ä»“åœŸç‹—ï¼Œä¼˜å…ˆä¿ä½æœ¬é‡‘ï¼Œç­‰å¾…æ›´å¥½æ—¶æœºã€‚';
                } else {
                    advice += 'å‡¶æ˜Ÿé«˜ç…§ï¼ŒåœŸç‹—è¿æå·®ï¼å®¹æ˜“æ¥ç›˜ã€è¢«å¥—ã€‚å¼ºçƒˆå»ºè®®æŒå¸è§‚æœ›ï¼Œæˆ–åªæŒBTC/ETHå¤§å¸ã€‚\nè€å¿ƒç­‰å¤§è¿åˆ°æ¥ï¼Œå¸åœˆæœ€å¿Œæ€¥èºï¼';
                }

                advice += `\n\næ—¥ä¸»å¼ºåº¦å½±å“ï¼ˆ${strength}åˆ†ï¼‰ï¼š\n`;
                if (strength > 80) advice += 'æ—¥ä¸»ææ—ºï¼Œå¤©ç”ŸèµŒæ€§å¼ºï¼Œé€‚åˆé«˜é£é™©æ“ä½œï¼ŒæŠŠæ¡èŠ‚å¥æ˜“å¤§æˆï¼';
                else if (strength > 60) advice += 'æ—¥ä¸»è¾ƒå¼ºï¼ŒæŠ—é£é™©èƒ½åŠ›å¥½ï¼Œå¯é€‚å½“åŠ å¤§ä»“ä½ã€‚';
                else if (strength > 40) advice += 'æ—¥ä¸»ä¸­ç­‰ï¼Œå»ºè®®ç¨³å¥æ“ä½œï¼Œæ§åˆ¶ä»“ä½ã€‚';
                else advice += 'æ—¥ä¸»åå¼±ï¼Œé£é™©æ‰¿å—åŠ›ä½ï¼Œå»ºè®®ä¿å®ˆç­–ç•¥ï¼Œé¿å…è¿‡åº¦æŠ•æœºã€‚';

                advice += `\näº”è¡Œå¹³è¡¡åº¦ï¼ˆ${balance}/100ï¼‰ï¼š\n`;
                if (balance > 80) advice += 'äº”è¡Œæå¹³è¡¡ï¼Œå†³ç­–ç†æ€§ï¼Œä¸æ˜“è¢«æƒ…ç»ªå¸¦åŠ¨ï¼Œé€‚åˆé•¿æœŸå¸ƒå±€ã€‚';
                else if (balance > 60) advice += 'äº”è¡Œè¾ƒå¹³è¡¡ï¼Œæ•´ä½“ç¨³å®šï¼ŒçŸ­æœŸæ³¢åŠ¨å¯æ§ã€‚';
                else advice += 'äº”è¡Œç¨å¤±è¡¡ï¼Œæƒ…ç»ªæ˜“æ³¢åŠ¨ï¼Œå»ºè®®å¤šæ€è€ƒå°‘å†²åŠ¨ã€‚';

                advice += `\n\nä»Šæ—¥è´¢è¿æŒ‡æ•°ï¼š${wealth}/100ï¼ˆè¶Šé«˜è¶Šé€‚åˆæŠ•æœºï¼‰\nç»¼åˆè¿åŠ¿æŒ‡æ•°ï¼š${overall}/100\n\nâš ï¸ ä»¥ä¸Šçº¯å±å¨±ä¹åˆ†æï¼ŒåŠ å¯†å¸‚åœºé£é™©æé«˜ï¼Œè¯·ç†æ€§æŠ•èµ„ï¼Œé‡åŠ›è€Œè¡Œï¼`;

                return advice;
            }

            // ä¸ºå›¾ç‰‡ç”Ÿæˆç®€åŒ–çš„åœŸç‹—è¿åŠ¿åˆ†æ
            generateSimpleCryptoAdvice(fortune) {
                const wealth = fortune.fortuneIndices.wealth;
                const wx = fortune.dayMasterWuXing;
                const detail = {
                    'æœ¨': { style: 'æˆé•¿å™äº‹å‹', recommend: 'Layer2ã€AIã€RWA' },
                    'ç«': { style: 'çƒ­ç‚¹çˆ†ç‚’å‹', recommend: 'Memeã€ç¤¾äº¤Fi' },
                    'åœŸ': { style: 'ç¨³å¥è“ç­¹å‹', recommend: 'BTCã€ETHã€å¹³å°å¸' },
                    'é‡‘': { style: 'é«˜é£é™©å®çŸ³å‹', recommend: 'æ½œåŠ›100xã€æ–°å…¬é“¾' },
                    'æ°´': { style: 'å¿«è¿›å¿«å‡ºå‹', recommend: 'DEXã€æµåŠ¨æ€§æŒ–çŸ¿' }
                }[wx] || { style: 'å¹³è¡¡çµæ´»å‹', recommend: 'å¤šé“¾å¸ƒå±€' };

                let level, advice;
                if (wealth >= 80) {
                    level = 'ğŸ”¥ è´¢è¿çˆ†æ£š ğŸ”¥';
                    advice = 'å¤§èƒ†å‡ºå‡»ï¼Œä»Šæ—¥å®¹æ˜“åƒå¤§è‚‰ï¼é€‚åˆä¸Šæ–°é¡¹ç›®ï¼Œè·ŸKOLåƒè‚‰ï¼';
                } else if (wealth >= 70) {
                    level = 'ğŸ‘ è¿åŠ¿è‰¯å¥½ ğŸ‘';
                    advice = 'è½»ä¸­ä»“ä½è·Ÿçƒ­ç‚¹ï¼Œå®¹æ˜“å°èµšä¸€æ³¢ã€‚å…³æ³¨ç¤¾åŒºçƒ­åº¦é«˜çš„é¡¹ç›®ã€‚';
                } else if (wealth >= 60) {
                    level = 'ğŸ“Š è¿åŠ¿å¹³ç¨³ ğŸ“Š';
                    advice = 'å¯å°ç©æ€¡æƒ…ï¼Œä¼˜å…ˆè€é¡¹ç›®ï¼Œé¿å…ç›²ç›®FOMOã€‚';
                } else if (wealth >= 45) {
                    level = 'âš ï¸ æ³¨æ„é£é™© âš ï¸';
                    advice = 'å¸‚åœºéœ‡è¡ï¼Œå»ºè®®è§‚æœ›ä¸ºä¸»ï¼Œåªç”¨å¨±ä¹èµ„é‡‘å°è¯•ã€‚';
                } else {
                    level = 'âŒ ä¸å®œæ“ä½œ âŒ';
                    advice = 'åœŸç‹—è¿å·®ï¼Œå®¹æ˜“æ¥ç›˜ã€‚å¼ºçƒˆå»ºè®®æŒå¸è§‚æœ›ï¼Œç­‰å¾…æ—¶æœºã€‚';
                }

                return {
                    level,
                    wuxing: `äº”è¡Œå±æ€§ï¼š${wx}`,
                    style: `æŠ•èµ„é£æ ¼ï¼š${detail.style}`,
                    recommend: `æ¨èæ¿å—ï¼š${detail.recommend}`,
                    score: `è´¢è¿æŒ‡æ•°ï¼š${wealth}/100`,
                    advice
                };
            }

            generateMonthlyFortune(fortune) {
                const months = ['1','2','3','4','5','6','7','8','9','10','11','12'];
                let text = '2026å¹´é€æœˆè¿åŠ¿ç®€è¯„ï¼š\n\n';
                months.forEach((m,i) => {
                    const score = Math.round(50 + Math.sin(i) * 20 + fortune.age % 10 * 3 + i * 2);
                    const level = score > 75 ? 'æä½³' : score > 60 ? 'é¡ºåˆ©' : score > 45 ? 'å¹³ç¨³' : 'æ³¨æ„';
                    text += `${m}æœˆï¼š${score}åˆ† - ${level}\n`;
                });
                return text;
            }

            generateImproveAdvice(fortune) {
                const color = { 'æœ¨':'ç»¿è‰²', 'ç«':'çº¢è‰²', 'åœŸ':'é»„è‰²', 'é‡‘':'ç™½è‰²', 'æ°´':'é»‘è‰²' }[fortune.dayMasterWuXing];
                return `1. é¢œè‰²è°ƒç†ï¼šå¤šç©¿${color}ç³»è¡£ç‰©ã€è£…é¥°\n2. æ–¹ä½è°ƒç†ï¼šå®œå‘${this.wuXingDescriptions[fortune.dayMasterWuXing].æ–¹å‘}å‘å±•\n3. ç”Ÿæ´»ä¹ æƒ¯ï¼šæ—©ç¡æ—©èµ·ã€é€‚åº¦è¿åŠ¨ã€è¡Œå–„ç§¯å¾·\n4. äººé™…è´µäººï¼šå¤šç»“å–„ç¼˜ï¼Œå¯»æ±‚æ—¥ä¸»åŒäº”è¡Œä¹‹äººç›¸åŠ©`;
            }
        }

        const engine = new FortuneEngine();
        const generator = new DetailedAnalysisGenerator();
        let currentFortune = null;

        function calculateFortune() {
            const year = parseInt(document.getElementById('year').value) || 1995;
            const month = parseInt(document.getElementById('month').value) || 1;
            const day = parseInt(document.getElementById('day').value) || 1;
            const hour = parseInt(document.getElementById('hour').value) || 12;
            const gender = document.getElementById('gender').value || 'male';

            currentFortune = engine.generateFortune(year, month, day, hour, gender);
            const report = generator.generateFullReport(currentFortune);

            document.getElementById('resultContainer').classList.remove('result-hidden');

            document.getElementById('baziDisplay').innerHTML = `
                <div>å¹´æŸ±ï¼š${currentFortune.baZi.year}</div>
                <div>æœˆæŸ±ï¼š${currentFortune.baZi.month}</div>
                <div>æ—¥æŸ±ï¼š${currentFortune.baZi.day}</div>
                <div>æ—¶æŸ±ï¼š${currentFortune.baZi.hour}</div>
            `;

            const wxOrder = ['æœ¨','ç«','åœŸ','é‡‘','æ°´'];
            document.getElementById('wuxingGrid').innerHTML = wxOrder.map(w => `
                <div class="wuxing-item">
                    <div>${w}</div>
                    <div class="wuxing-count">${currentFortune.wuXingCount[w]}</div>
                </div>
            `).join('');

            const idx = currentFortune.fortuneIndices;
            ['overall','wealth','career','love','health'].forEach(k => {
                document.getElementById(k+'Value').textContent = idx[k] + '%';
                document.getElementById(k+'Bar').style.width = idx[k] + '%';
            });

            document.getElementById('basicInfo').textContent = report.åŸºç¡€ä¿¡æ¯;
            document.getElementById('baziAnalysis').textContent = report.å…«å­—åˆ†æ;
            document.getElementById('wuxingAnalysis').textContent = report.äº”è¡Œåˆ†æ;
            document.getElementById('fortuneAnalysis').textContent = report.è¿åŠ¿åˆ†æ;
            document.getElementById('wealthAnalysis').textContent = report.è´¢è¿åˆ†æ;
            document.getElementById('careerAnalysis').textContent = report.äº‹ä¸šåˆ†æ;
            document.getElementById('loveAnalysis').textContent = report.æ„Ÿæƒ…åˆ†æ;
            document.getElementById('healthAdvice').textContent = report.å¥åº·å»ºè®®;
            document.getElementById('cryptoAdvice').textContent = report.å¸åœˆåœŸç‹—è¿åŠ¿;
            document.getElementById('monthlyFortune').textContent = report.é€æœˆè¿åŠ¿;
            document.getElementById('improveAdvice').textContent = report.æ”¹è¿å»ºè®®;

            switchTab(null, 'tab-crypto');
        }

        function switchTab(e, tabName) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            if (e) e.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            document.querySelector(`.tab-btn[onclick="switchTab(event, '${tabName}')"]`).classList.add('active');
        }

        // ç”ŸæˆåœŸç‹—è¿åŠ¿å›¾ç‰‡
        async function generateTugouImage() {
            if (!currentFortune) {
                alert('è¯·å…ˆè¿›è¡Œè¿åŠ¿åˆ†æï¼');
                return;
            }

            // æ˜¾ç¤ºåŠ è½½æç¤º
            const originalBtn = document.querySelector('.share-btn.download');
            const originalText = originalBtn.innerHTML;
            originalBtn.innerHTML = '<span>â³</span>ç”Ÿæˆä¸­...';
            originalBtn.disabled = true;

            try {
                // å‡†å¤‡å›¾ç‰‡æ¨¡æ¿å†…å®¹
                const simpleAdvice = generator.generateSimpleCryptoAdvice(currentFortune);
                const now = new Date();
                const dateStr = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥ ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;
                
                // æ›´æ–°æ¨¡æ¿å†…å®¹
                document.getElementById('templateDate').textContent = dateStr;
                document.getElementById('templateWuxing').innerHTML = `
                    <p>${simpleAdvice.wuxing}</p>
                    <p>${simpleAdvice.style}</p>
                    <p>${simpleAdvice.recommend}</p>
                    <p>${simpleAdvice.score}</p>
                    <p style="color: #ff8e53; font-weight: 700; margin-top: 15px;">${simpleAdvice.level}</p>
                `;
                document.getElementById('templateAdvice').textContent = simpleAdvice.advice;

                // ä½¿ç”¨html2canvasç”Ÿæˆå›¾ç‰‡
                const template = document.getElementById('tugouImageTemplate');
                
                // ç­‰å¾…æ¨¡æ¿æ¸²æŸ“
                await new Promise(resolve => setTimeout(resolve, 100));
                
                const canvas = await html2canvas(template, {
                    scale: 2, // æé«˜åˆ†è¾¨ç‡
                    backgroundColor: null,
                    useCORS: true,
                    allowTaint: true
                });

                // è½¬æ¢ä¸ºå›¾ç‰‡URL
                const imageUrl = canvas.toDataURL('image/png');
                
                // æ˜¾ç¤ºé¢„è§ˆ
                document.getElementById('imagePreview').src = imageUrl;
                document.getElementById('imagePreviewContainer').style.display = 'flex';
                
                // å­˜å‚¨å›¾ç‰‡URLç”¨äºä¸‹è½½
                document.getElementById('imagePreview').dataset.downloadUrl = imageUrl;
                
            } catch (error) {
                console.error('ç”Ÿæˆå›¾ç‰‡å¤±è´¥:', error);
                alert('ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·é‡è¯•ï¼');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                originalBtn.innerHTML = originalText;
                originalBtn.disabled = false;
            }
        }

        // ä¸‹è½½å›¾ç‰‡
        function downloadImage() {
            const imageUrl = document.getElementById('imagePreview').dataset.downloadUrl;
            if (!imageUrl) return;
            
            const link = document.createElement('a');
            link.href = imageUrl;
            link.download = `åœŸç‹—è¿åŠ¿_${new Date().toISOString().slice(0,10)}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // å…³é—­é¢„è§ˆ
        function closePreview() {
            document.getElementById('imagePreviewContainer').style.display = 'none';
        }

        // åˆ†äº«åˆ°å¾®ä¿¡ï¼ˆæ¨¡æ‹Ÿï¼‰
        function shareToWechat() {
            if (!currentFortune) {
                alert('è¯·å…ˆè¿›è¡Œè¿åŠ¿åˆ†æï¼');
                return;
            }
            
            alert('åˆ†äº«åŠŸèƒ½å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼\n\nå¯ä»¥å°†ç»“æœåˆ†äº«ç»™å¥½å‹ï¼Œæˆ–è€…ç”Ÿæˆå›¾ç‰‡ååˆ†äº«ã€‚\n\næç¤ºï¼šåœ¨ç§»åŠ¨ç«¯ï¼Œå¯ä»¥é•¿æŒ‰å›¾ç‰‡é€‰æ‹©åˆ†äº«ã€‚');
            
            // å¤åˆ¶åˆ†äº«æ–‡æ¡ˆåˆ°å‰ªè´´æ¿
            const shareText = `ğŸ”¥ æˆ‘çš„å¸åœˆåœŸç‹—è¿åŠ¿ ğŸ”¥\n\n` +
                            `äº”è¡Œï¼š${currentFortune.dayMasterWuXing}\n` +
                            `è´¢è¿æŒ‡æ•°ï¼š${currentFortune.fortuneIndices.wealth}/100\n` +
                            `ç»¼åˆè¿åŠ¿ï¼š${currentFortune.fortuneIndices.overall}/100\n\n` +
                            `æ¥è‡ªï¼šç„å­¦Â·å¸è¿å¤§å¸ˆ\n` +
                            `ï¼ˆä»…ä¾›å¨±ä¹å‚è€ƒï¼‰`;
            
            navigator.clipboard.writeText(shareText).then(() => {
                console.log('åˆ†äº«æ–‡æ¡ˆå·²å¤åˆ¶åˆ°å‰ªè´´æ¿');
            });
        }

        function initDays() {
            const daySelect = document.getElementById('day');
            daySelect.innerHTML = '';
            const year = parseInt(document.getElementById('year').value) || new Date().getFullYear();
            const month = parseInt(document.getElementById('month').value) || 1;
            const daysInMonth = new Date(year, month, 0).getDate();
            for (let i = 1; i <= daysInMonth; i++) {
                const selected = (i === 1) ? ' selected' : '';
                daySelect.innerHTML += `<option value="${i}"${selected}>${i}æ—¥</option>`;
            }
        }

        document.getElementById('year').addEventListener('change', initDays);
        document.getElementById('month').addEventListener('change', initDays);

        // é¡µé¢åŠ è½½ç«‹å³åˆå§‹åŒ–
        window.onload = function() {
            initDays();
        };
    </script>
</body>
</html>